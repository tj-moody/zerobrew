#!/bin/bash
set -e

# zerobrew uninstaller
# Removes zerobrew, its files, and cleans up shell configuration

echo "Uninstalling zerobrew..."
echo ""

ZEROBREW_DIR="$HOME/.zerobrew"
ZEROBREW_BIN="$HOME/.local/bin/zb"
ZEROBREW_OPT="/opt/zerobrew"

# Function to remove zerobrew lines from a shell config file
clean_shell_config() {
    local config_file="$1"
    if [[ -f "$config_file" ]]; then
        # Create a temp file
        local tmp_file=$(mktemp)

        # Remove lines containing zerobrew paths or the zerobrew comment
        grep -v -E '# zerobrew|\.local/bin.*PATH|/opt/zerobrew' "$config_file" > "$tmp_file" 2>/dev/null || true

        # Remove consecutive blank lines (cleanup)
        cat -s "$tmp_file" > "$config_file"
        rm "$tmp_file"

        echo "Cleaned $config_file"
    fi
}

# Clean shell configuration files
echo "Cleaning shell configuration..."
clean_shell_config "$HOME/.zshrc"
clean_shell_config "$HOME/.bashrc"
clean_shell_config "$HOME/.bash_profile"
clean_shell_config "$HOME/.profile"

# Remove the zb binary
if [[ -f "$ZEROBREW_BIN" ]]; then
    rm "$ZEROBREW_BIN"
    echo "Removed $ZEROBREW_BIN"
fi

# Remove the zerobrew source directory
if [[ -d "$ZEROBREW_DIR" ]]; then
    rm -rf "$ZEROBREW_DIR"
    echo "Removed $ZEROBREW_DIR"
fi

# Remove /opt/zerobrew (requires sudo)
if [[ -d "$ZEROBREW_OPT" ]]; then
    echo ""
    echo "Removing $ZEROBREW_OPT (requires sudo)..."
    sudo rm -rf "$ZEROBREW_OPT"
    echo "Removed $ZEROBREW_OPT"
fi

echo ""
echo "============================================"
echo "  zerobrew uninstalled successfully!"
echo "============================================"
echo ""
echo "Restart your terminal or run:"
echo "    exec \$SHELL"
echo ""
